#!/usr/bin/env ruby

require File.expand_path(
    File.join(File.dirname(__FILE__), %w[.. lib rspec-cukeapp]))

# Path to Cuke.app binary
cuke_path = File.join(File.dirname(__FILE__), '..', 'vendor', 'Cuke.app', 'Contents', 'MacOS', 'Cuke')

# Find a location to write our html file
path = "/tmp/cuke-#{Process.pid}.html"
FileUtils.touch(path)

# Pass through the args, but escape any double quotes
args = ARGV.join(' ').gsub(/\"/, '\"')

# Run specs; show updates
rake_cmd = "rake spec SPEC_OPTS=\"--format CukeappFormatter #{args}\" 1> #{path} "
puts "Rake cmd: #{rake_cmd}"
rake_pid = fork {
  `#{rake_cmd}`
}

cuke_cmd = "open -a #{cuke_path} --args #{path}"
puts "Cuke cmd: #{cuke_cmd}"
system cuke_cmd

at_exit { Process.wait }

# EOF
